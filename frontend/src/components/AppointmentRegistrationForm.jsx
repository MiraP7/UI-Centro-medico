import React, { useState, useEffect } from 'react';
import { Dropdown } from 'primereact/dropdown';
import { Calendar } from 'primereact/calendar';
import { InputTextarea } from 'primereact/inputtextarea';
import { Button } from 'primereact/button';
import { Dialog } from 'primereact/dialog';

import PatientRegistrationForm from './PatientRegistrationForm';
import CitaService from '../Services/CitaService';

const citaService = new CitaService(); // Crear instancia del servicio

export default function AppointmentRegistrationForm({
    appointmentToEdit = null,
    onAppointmentRegistered,
    onCancel
}) {
    const [selectedPatient, setSelectedPatient] = useState(null);
    const [selectedMedico, setSelectedMedico] = useState(null);
    const [appointmentDate, setAppointmentDate] = useState(null);
    const [appointmentTime, setAppointmentTime] = useState('');
    const [selectedTreatment, setSelectedTreatment] = useState(null); // Cambiado de reason a selectedTreatment
    const [patients, setPatients] = useState([]);
    const [medicos, setMedicos] = useState([]);
    const [treatments, setTreatments] = useState([]); // Nuevo estado para tratamientos
    const [loadingPatients, setLoadingPatients] = useState(false);
    const [loadingMedicos, setLoadingMedicos] = useState(false);
    const [loadingTreatments, setLoadingTreatments] = useState(false); // Nuevo estado de carga

    const [showPatientRegistrationModal, setShowPatientRegistrationModal] = useState(false);

    // Determinar si estamos en modo edici√≥n
    const isEditMode = appointmentToEdit !== null;

    const timeSlots = [
        { label: '09:00 AM', value: '09:00 AM' }, { label: '09:30 AM', value: '09:30 AM' },
        { label: '10:00 AM', value: '10:00 AM' }, { label: '10:30 AM', value: '10:30 AM' },
        { label: '11:00 AM', value: '11:00 AM' }, { label: '11:30 AM', value: '11:30 AM' },
    ];

    // Efecto para pre-llenar campos cuando est√° en modo edici√≥n
    useEffect(() => {
        if (isEditMode && appointmentToEdit) {
            console.log('üîÑ Modo edici√≥n activado. Datos recibidos:', appointmentToEdit);

            // Pre-llenar campos con los datos de la cita a editar
            if (appointmentToEdit.pacienteId || appointmentToEdit.pacienteID) {
                const patientId = (appointmentToEdit.pacienteId || appointmentToEdit.pacienteID).toString();
                console.log('üë§ Configurando paciente ID:', patientId);
                setSelectedPatient(patientId);
            }

            // Manejar la fecha - puede venir como fechaHora o date
            if (appointmentToEdit.fechaHora || appointmentToEdit.date) {
                const dateValue = appointmentToEdit.fechaHora || appointmentToEdit.date;
                console.log('üìÖ Configurando fecha:', dateValue);
                setAppointmentDate(new Date(dateValue));
            }

            // Manejar la hora
            if (appointmentToEdit.time || appointmentToEdit.hora) {
                const timeValue = appointmentToEdit.time || appointmentToEdit.hora;
                console.log('üïê Configurando hora:', timeValue);
                setAppointmentTime(timeValue);
            }

            // Manejar el tratamiento - buscar por tratamientoId o descripci√≥n
            if (appointmentToEdit.tratamientoId) {
                const treatmentId = appointmentToEdit.tratamientoId.toString();
                console.log('üè• Configurando tratamiento ID:', treatmentId);
                setSelectedTreatment(treatmentId);
            } else if (appointmentToEdit.motivoConsulta || appointmentToEdit.reason) {
                // Si no hay tratamientoId, buscar por descripci√≥n cuando los tratamientos est√©n cargados
                const reasonValue = appointmentToEdit.motivoConsulta || appointmentToEdit.reason;
                console.log('üìù Tratamiento por descripci√≥n:', reasonValue);
                // Esto se manejar√° en un useEffect separado cuando los tratamientos est√©n cargados
                setSelectedTreatment(reasonValue);
            }

            // Pre-llenar m√©dico si existe
            if (appointmentToEdit.medicoId || appointmentToEdit.medicoID) {
                const medicoId = (appointmentToEdit.medicoId || appointmentToEdit.medicoID).toString();
                console.log('üë®‚Äç‚öïÔ∏è Configurando m√©dico ID:', medicoId);
                setSelectedMedico(medicoId);
            }

            console.log('‚úÖ Campos configurados para edici√≥n');
        } else {
            console.log('üÜï Modo creaci√≥n - limpiando campos');
            // Limpiar campos en modo creaci√≥n
            setSelectedPatient(null);
            setSelectedMedico(null);
            setAppointmentDate(null);
            setAppointmentTime('');
            setSelectedTreatment(null);
        }
    }, [isEditMode, appointmentToEdit]);

    // Funci√≥n para cargar tratamientos desde la API
    const loadTreatments = async () => {
        try {
            console.log('üîÑ Iniciando carga de tratamientos...');
            setLoadingTreatments(true);

            const response = await fetch('https://localhost:44388/api/Tratamiento/all', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                console.log('üìä Datos de tratamientos recibidos:', result);

                // Verificar si hay datos
                if (!result || !Array.isArray(result.data)) {
                    console.warn('‚ö†Ô∏è Los datos de tratamientos no son un array v√°lido:', result);
                    setTreatments([]);
                    return;
                }

                // Transformar los datos para el formato del Dropdown
                const formattedTreatments = result.data.map(treatment => {
                    console.log('üîÑ Procesando tratamiento:', treatment);

                    const treatmentId = treatment.tratamientoId || treatment.id;

                    if (!treatmentId) {
                        console.warn('‚ö†Ô∏è Tratamiento sin ID v√°lido:', treatment);
                        return null;
                    }

                    return {
                        label: `${treatment.descripcion} - $${treatment.costo}`,
                        value: treatmentId.toString(),
                        descripcion: treatment.descripcion,
                        costo: treatment.costo
                    };
                }).filter(treatment => treatment !== null);

                console.log('‚úÖ Tratamientos formateados:', formattedTreatments);
                setTreatments(formattedTreatments);

                if (formattedTreatments.length === 0) {
                    console.warn('‚ö†Ô∏è No se pudieron formatear tratamientos v√°lidos');
                }
            } else {
                const errorData = await response.json();
                console.error('‚ùå Error de API al cargar tratamientos:', response.status, errorData);
                setTreatments([]);
            }
        } catch (error) {
            console.error('‚ùå Error al cargar tratamientos:', error);
            console.error('‚ùå Detalles del error:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            setTreatments([]);
        } finally {
            setLoadingTreatments(false);
        }
    };

    // Funci√≥n para cargar pacientes desde la API
    const loadPatients = async () => {
        try {
            console.log('üîÑ Iniciando carga de pacientes...');
            setLoadingPatients(true);
            const patientsData = await citaService.getAllPacientes();
            console.log('üìä Datos de pacientes recibidos:', patientsData);

            // Verificar si hay datos
            if (!patientsData || !Array.isArray(patientsData)) {
                console.warn('‚ö†Ô∏è Los datos de pacientes no son un array v√°lido:', patientsData);
                setPatients([]);
                return;
            }

            // Transformar los datos para el formato del Dropdown
            const formattedPatients = patientsData.map(patient => {
                console.log('üîÑ Procesando paciente:', patient);

                // Manejar diferentes formatos de ID (pacienteId vs pacienteID)
                const patientId = patient.pacienteId || patient.pacienteID || patient.id;

                // Manejar diferentes formatos de c√©dula
                const cedula = patient.cedula || patient.numeroIdentificacion || patient.cedulaIdentidad || 'Sin c√©dula';
                console.log('üìÑ C√©dula encontrada:', cedula, 'para paciente:', patient.nombre);

                if (!patientId) {
                    console.warn('‚ö†Ô∏è Paciente sin ID v√°lido:', patient);
                    return null; // Retornar null para filtrar despu√©s
                }

                return {
                    label: `${patient.nombre || 'Sin nombre'} ${patient.apellido || 'Sin apellido'} (C√©dula: ${cedula})`,
                    value: patientId.toString(),
                    name: `${patient.nombre || 'Sin nombre'} ${patient.apellido || 'Sin apellido'}`
                };
            }).filter(patient => patient !== null); // Filtrar pacientes nulos            console.log('‚úÖ Pacientes formateados:', formattedPatients);
            setPatients(formattedPatients);

            if (formattedPatients.length === 0) {
                console.warn('‚ö†Ô∏è No se pudieron formatear pacientes v√°lidos');
            }
        } catch (error) {
            console.error('‚ùå Error al cargar pacientes:', error);
            console.error('‚ùå Detalles del error:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            setPatients([]);
        } finally {
            setLoadingPatients(false);
        }
    };

    // Funci√≥n para cargar m√©dicos desde la API
    const loadMedicos = async () => {
        try {
            console.log('üîÑ Iniciando carga de m√©dicos...');
            setLoadingMedicos(true);
            const medicosData = await citaService.getAllMedicos();
            console.log('üìä Datos de m√©dicos recibidos:', medicosData);

            // Verificar si hay datos
            if (!medicosData || !Array.isArray(medicosData)) {
                console.warn('‚ö†Ô∏è Los datos de m√©dicos no son un array v√°lido:', medicosData);
                setMedicos([]);
                return;
            }

            // Transformar los datos para el formato del Dropdown
            const formattedMedicos = medicosData.map(medico => {
                console.log('üîÑ Procesando m√©dico:', medico);

                // Manejar diferentes formatos de ID (medicoId vs medicoID)
                const medicoId = medico.medicoId || medico.medicoID || medico.id;

                // Manejar diferentes formatos de c√©dula
                const cedula = medico.cedula || medico.numeroIdentificacion || medico.cedulaIdentidad || 'Sin c√©dula';
                console.log('üìÑ C√©dula encontrada:', cedula, 'para m√©dico:', medico.nombre);

                if (!medicoId) {
                    console.warn('‚ö†Ô∏è M√©dico sin ID v√°lido:', medico);
                    return null; // Retornar null para filtrar despu√©s
                }

                return {
                    label: `Dr. ${medico.nombre || 'Sin nombre'} ${medico.apellido || 'Sin apellido'} (C√©dula: ${cedula})`,
                    value: medicoId.toString(),
                    name: `Dr. ${medico.nombre || 'Sin nombre'} ${medico.apellido || 'Sin apellido'}`
                };
            }).filter(medico => medico !== null); // Filtrar m√©dicos nulos            console.log('‚úÖ M√©dicos formateados:', formattedMedicos);
            setMedicos(formattedMedicos);

            if (formattedMedicos.length === 0) {
                console.warn('‚ö†Ô∏è No se pudieron formatear m√©dicos v√°lidos');
            }
        } catch (error) {
            console.error('‚ùå Error al cargar m√©dicos:', error);
            console.error('‚ùå Detalles del error:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            setMedicos([]);
        } finally {
            setLoadingMedicos(false);
        }
    };

    // Cargar pacientes, m√©dicos y tratamientos al montar el componente
    useEffect(() => {
        loadPatients();
        loadMedicos();
        loadTreatments();
    }, []);

    // UseEffect para manejar la selecci√≥n de tratamiento por descripci√≥n cuando los tratamientos est√©n cargados
    useEffect(() => {
        if (isEditMode && appointmentToEdit && treatments.length > 0 && selectedTreatment) {
            // Si selectedTreatment es una descripci√≥n (string largo), buscar el ID correspondiente
            if (isNaN(selectedTreatment) && selectedTreatment.length > 5) {
                console.log('üîç Buscando tratamiento por descripci√≥n:', selectedTreatment);
                const foundTreatment = treatments.find(treatment =>
                    treatment.descripcion.toLowerCase().includes(selectedTreatment.toLowerCase()) ||
                    selectedTreatment.toLowerCase().includes(treatment.descripcion.toLowerCase())
                );

                if (foundTreatment) {
                    console.log('‚úÖ Tratamiento encontrado por descripci√≥n:', foundTreatment);
                    setSelectedTreatment(foundTreatment.value);
                } else {
                    console.warn('‚ö†Ô∏è No se encontr√≥ tratamiento para la descripci√≥n:', selectedTreatment);
                }
            }
        }
    }, [treatments, isEditMode, appointmentToEdit]);

    const handlePatientRegistered = (newPatient) => {
        console.log('Paciente Registrado desde el modal:', newPatient);
        setShowPatientRegistrationModal(false);
        // Recargar la lista de pacientes despu√©s de registrar uno nuevo
        loadPatients();
    };

    const handleCancelPatientRegistration = () => {
        setShowPatientRegistrationModal(false);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!selectedPatient || !selectedMedico || !appointmentDate || !appointmentTime || !selectedTreatment) {
            alert('Todos los campos son obligatorios.');
            return;
        }

        const patientDetails = patients.find(p => p.value === selectedPatient);
        const medicoDetails = medicos.find(m => m.value === selectedMedico);
        const treatmentDetails = treatments.find(t => t.value === selectedTreatment);

        if (isEditMode) {
            // **MODO EDICI√ìN**: Formato para PUT - necesita c√©dulas
            console.log('üîÑ === MODO EDICI√ìN - PREPARANDO DATOS PARA PUT ===');

            // Extraer c√©dulas de los labels de los dropdowns
            const pacienteCedula = extractCedulaFromLabel(patientDetails?.label || '');
            const medicoCedula = extractCedulaFromLabel(medicoDetails?.label || '');

            console.log('üë§ C√©dula del paciente extra√≠da:', pacienteCedula);
            console.log('üë®‚Äç‚öïÔ∏è C√©dula del m√©dico extra√≠da:', medicoCedula);

            const editAppointmentData = {
                pacienteCedula: pacienteCedula,
                medicoCedula: medicoCedula,
                fechaHora: appointmentDate.toISOString().split('T')[0] + 'T' + convertTimeToAPI(appointmentTime),
                motivoConsulta: treatmentDetails ? treatmentDetails.descripcion : 'Tratamiento no especificado', // Enviar descripci√≥n como string
                estadoId: 102, // Usar estadoId (consistente entre POST y PUT)
                // Para Dashboard - ID de la cita para URL
                citaId: parseInt(appointmentToEdit.citaId || appointmentToEdit.citaID),
                // Campos adicionales para el frontend
                patientName: patientDetails ? patientDetails.name : 'Desconocido',
                medicoName: medicoDetails ? medicoDetails.name : 'Desconocido',
                treatmentName: treatmentDetails ? treatmentDetails.descripcion : 'Desconocido',
                tratamientoId: parseInt(selectedTreatment), // Mantener ID para uso interno del frontend
                date: appointmentDate.toLocaleDateString('es-ES'),
                time: appointmentTime,
                isEditMode: true // Bandera para que Dashboard sepa el modo
            };

            console.log('üì§ Datos para EDITAR cita:', editAppointmentData);
            onAppointmentRegistered(editAppointmentData);
        } else {
            // **MODO CREACI√ìN**: Formato para POST - necesita c√©dulas tambi√©n
            console.log('üÜï === MODO CREACI√ìN - PREPARANDO DATOS PARA POST ===');

            // Extraer c√©dulas de los labels de los dropdowns (igual que en edici√≥n)
            const pacienteCedula = extractCedulaFromLabel(patientDetails?.label || '');
            const medicoCedula = extractCedulaFromLabel(medicoDetails?.label || '');

            console.log('üë§ C√©dula del paciente extra√≠da:', pacienteCedula);
            console.log('üë®‚Äç‚öïÔ∏è C√©dula del m√©dico extra√≠da:', medicoCedula);

            // Generar un citaId temporal para el POST (el servidor puede asignar el real)
            const temporalCitaId = Date.now(); // Usar timestamp como ID temporal

            const createAppointmentData = {
                citaId: temporalCitaId, // Incluir citaId para la l√≥gica del frontend
                pacienteCedula: pacienteCedula,  // POST usa c√©dulas
                medicoCedula: medicoCedula,      // POST usa c√©dulas
                fechaHora: appointmentDate.toISOString().split('T')[0] + 'T' + convertTimeToAPI(appointmentTime),
                motivoConsulta: treatmentDetails ? treatmentDetails.descripcion : 'Tratamiento no especificado', // Enviar descripci√≥n como string
                estadoId: 102, // Usar estadoId (consistente con PUT)
                // Campos adicionales para el frontend
                patientName: patientDetails ? patientDetails.name : 'Desconocido',
                medicoName: medicoDetails ? medicoDetails.name : 'Desconocido',
                treatmentName: treatmentDetails ? treatmentDetails.descripcion : 'Desconocido',
                tratamientoId: parseInt(selectedTreatment), // Mantener ID para uso interno del frontend
                date: appointmentDate.toLocaleDateString('es-ES'),
                time: appointmentTime,
                isEditMode: false // Bandera para que Dashboard sepa el modo
            };

            console.log('üì§ Datos para CREAR cita (con c√©dulas):', createAppointmentData);
            onAppointmentRegistered(createAppointmentData);
        }
    };

    // Funci√≥n auxiliar para extraer c√©dula del label del dropdown
    const extractCedulaFromLabel = (label) => {
        // El label tiene formato: "Nombre Apellido (C√©dula: 00598765432)"
        const match = label.match(/C√©dula:\s*(\w+)/);
        return match ? match[1] : '';
    };

    // Funci√≥n auxiliar para convertir la hora del formato del frontend al formato de la API
    const convertTimeToAPI = (timeString) => {
        // Convertir "10:30 AM" a "10:30:00"
        const [time, period] = timeString.split(' ');
        let [hours, minutes] = time.split(':');

        if (period === 'PM' && hours !== '12') {
            hours = (parseInt(hours) + 12).toString();
        } else if (period === 'AM' && hours === '12') {
            hours = '00';
        }

        return `${hours.padStart(2, '0')}:${minutes}:00`;
    };

    return (
        <form onSubmit={handleSubmit} className="p-fluid grid formgrid container-dialog">
            {/* TEMPORAL: Bot√≥n de debug */}
            {/* <div className="col-12 mb-2">
                <div className="grid">
                    <div className="col-6">
                        <Button
                            type="button"
                            label={`Debug - Pacientes (${patients.length})`}
                            className="p-button-secondary p-button-sm w-full"
                            onClick={loadPatients}
                            loading={loadingPatients}
                        />
                        {patients.length > 0 && (
                            <small className="block mt-1 text-green-500">
                                ‚úÖ Pacientes: {patients.map(p => p.name).join(', ')}
                            </small>
                        )}
                    </div>
                    <div className="col-6">
                        <Button
                            type="button"
                            label={`Debug - M√©dicos (${medicos.length})`}
                            className="p-button-secondary p-button-sm w-full"
                            onClick={loadMedicos}
                            loading={loadingMedicos}
                        />
                        {medicos.length > 0 && (
                            <small className="block mt-1 text-green-500">
                                ‚úÖ M√©dicos: {medicos.map(m => m.name).join(', ')}
                            </small>
                        )}
                    </div>
                </div>
            </div> */}

            {/* Mensaje informativo en modo edici√≥n */}
            {isEditMode && appointmentToEdit && (
                <div className="col-12 mb-3">
                    <div className="p-3 border-round" style={{ backgroundColor: '#fff3cd', border: '1px solid #ffeaa7', color: '#856404' }}>
                        <i className="pi pi-info-circle mr-2"></i>
                        <strong>Editando Cita ID: {appointmentToEdit.citaId}</strong>
                        <br />
                        <small>Modifica los campos necesarios y guarda los cambios.</small>
                    </div>
                </div>
            )}

            {/* Bot√≥n para abrir el formulario de registro de paciente - Solo mostrar en modo creaci√≥n */}
            {!isEditMode && (
                <Button
                    type="button"
                    label="Registrar Paciente"
                    className="p-button-text"
                    onClick={() => setShowPatientRegistrationModal(true)}
                />
            )}

            <div className="field col-12">
                <label htmlFor="patient">Paciente</label>
                <Dropdown
                    id="patient"
                    value={selectedPatient}
                    options={patients}
                    onChange={(e) => setSelectedPatient(e.value)}
                    placeholder={loadingPatients ? "Cargando pacientes..." : "Seleccionar Paciente"}
                    loading={loadingPatients}
                    onShow={loadPatients}
                    filter
                    filterPlaceholder="Buscar..."
                    emptyMessage="No se encontraron pacientes"
                    required
                />
            </div>

            <div className="field col-12">
                <label htmlFor="medico">M√©dico</label>
                <Dropdown
                    id="medico"
                    value={selectedMedico}
                    options={medicos}
                    onChange={(e) => setSelectedMedico(e.value)}
                    placeholder={loadingMedicos ? "Cargando m√©dicos..." : "Seleccionar M√©dico"}
                    loading={loadingMedicos}
                    onShow={loadMedicos}
                    filter
                    filterPlaceholder="Buscar..."
                    emptyMessage="No se encontraron m√©dicos"
                    required
                />
            </div>

            <div className="field col-12 md:col-6">
                <label htmlFor="appointmentDate">Fecha</label>
                <Calendar id="appointmentDate" value={appointmentDate} onChange={(e) => setAppointmentDate(e.value)} dateFormat="dd/mm/yy" showIcon required minDate={new Date()} />
            </div>
            <div className="field col-12 md:col-6">
                <label htmlFor="appointmentTime">Hora</label>
                <Dropdown id="appointmentTime" value={appointmentTime} options={timeSlots} onChange={(e) => setAppointmentTime(e.value)} placeholder="Seleccionar Hora" required />
            </div>
            <div className="field col-12">
                <label htmlFor="treatment">Tratamiento</label>
                <Dropdown
                    id="treatment"
                    value={selectedTreatment}
                    options={treatments}
                    onChange={(e) => setSelectedTreatment(e.value)}
                    placeholder={loadingTreatments ? "Cargando tratamientos..." : "Seleccionar Tratamiento"}
                    loading={loadingTreatments}
                    onShow={loadTreatments}
                    filter
                    filterPlaceholder="Buscar tratamiento..."
                    emptyMessage="No se encontraron tratamientos"
                    required
                />
            </div>

            <div className="col-12 flex justify-content-end gap-2 mt-4">
                {/* <Button type="button" label="Cancelar" icon="pi pi-times" className="p-button-text" onClick={onCancel} /> */}
                <Button type="submit" label={isEditMode ? "Editar Cita" : "Registrar Cita"} /> {/* icon="pi pi-check" /> */}
            </div>

            {/* Componente Dialog para mostrar PatientRegistrationForm */}
            <Dialog
                header="Registrar Paciente"
                visible={showPatientRegistrationModal}
                style={{ width: '50vw' }}
                modal
                onHide={handleCancelPatientRegistration}
            >
                {/* Renderiza el formulario de registro de paciente dentro del Dialog */}
                <PatientRegistrationForm
                    onPatientRegistered={handlePatientRegistered}
                    onCancel={handleCancelPatientRegistration}
                />
            </Dialog>
        </form>
    );
}